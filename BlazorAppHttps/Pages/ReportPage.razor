@page "/report"

@inject IJSRuntime _jsRuntime
@inject NavigationManager _navigationManager
@using BlazorAppHttps.Data
@inject IReportService _reportService

<div class="container d-flex justify-content-center my-5">

    <div class="form-container p-4 mx-3 mx-sm-0">

        <h1 class="h2 mb-3 fw-bold w-100 text-center text-white" style="opacity: var(--custom-text-alpha-a);">作業日誌</h1>

        <h1 class="h4 mb-3 w-100 text-center text-white" style="opacity: var(--custom-text-alpha-a);">@_reportService.Protocol.Title</h1>

        <form>

            <div class="text-white mb-2">

                <FullSizeInput Label="担当者" Type="info" Info="@_reportService.OperatorName.Trim()"/>
                <FullSizeInput Label="開始時間" Type="info"
                               Info="@_reportService.ProtocolStart.ToString(_reportService.TimeFormat)"/>
                <FullSizeInput Label="終了時刻" Type="info"
                               Info="@_reportService.ProtocolEnd.ToString(_reportService.TimeFormat)"/>

                <div class="mb-2" style="height: 5px; background-color: var(--custom-primary-color);"></div>

                @if (_reportService.Protocol.LogType == "Simple")
                {
                    <SimpleInput Type="info" Title="処理検体数" Info="@_reportService.Inputs.KeyValue"></SimpleInput>
                }
                else if (_reportService.Protocol.LogType == "DnaTray")
                {
                    <DnaTrayInput Type="info" Info="@_reportService.Inputs.KeyValue"></DnaTrayInput>
                }

                <div class="mb-2" style="height: 5px; background-color: var(--custom-primary-color);"></div>

                @foreach (var pair in _reportService.Logs)
                {
                    <FullSizeInput Label="@pair.Key" Type="info"
                                   Info="@pair.Value.ToString(_reportService.TimeFormat)"/>
                }

            </div>
            
            <div class="mb-2" style="height: 5px; background-color: var(--custom-primary-color);"></div>

            <button class="btn btn-lg w-100 text-white" style="background-color: var(--custom-primary-color);"
                    type="button">
                送信
            </button>

        </form>

    </div>

</div>


@code {

    protected override void OnInitialized()
    {
        if (_reportService.Protocol == null || _reportService.ProtocolStart == default || _reportService.ProtocolEnd == default)
        {
            _navigationManager.NavigateTo($"/");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await _jsRuntime.InvokeVoidAsync("removeListeners");
            
            if (!string.IsNullOrWhiteSpace(_reportService.Protocol.EndingAudioUrl))
            {
                await _jsRuntime.InvokeVoidAsync("playAudio", _reportService.Protocol.EndingAudioUrl);
            }
        }
    }

}